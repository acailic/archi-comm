# Demo Screenshot Generation

Create marketing-ready screenshots directly from the Playwright E2E suite. The screenshot workflow mirrors the existing demo video recorder while emphasising crisp, artifact-free stills for docs, decks, and social channels.

## Quick Start

```bash
npm run demo:prepare             # Verify prerequisites and create fresh run folders
npm run demo:screenshots          # Generate the full gallery
npm run demo:screenshots:features # Feature showcase only
npm run demo:screenshots:list     # View available categories
npm run e2e:screenshots           # Run capture spec once (uses demo-screenshots project)
```

Each execution writes to `demo-screenshots/runs/<runId>/…` with a copy of the latest run mirrored in `demo-screenshots/latest/`. Aggregated metadata lives in `demo-screenshots/metadata/` alongside the HTML gallery.

## Available Categories

| Category | Description | Typical Use |
| --- | --- | --- |
| `feature-showcase` | Palette, annotation, export flows | Landing pages, product tours |
| `architecture-examples` | E-commerce, microservices, cloud-native | Case studies, whitepapers |
| `workflow-stages` | Empty → in-progress → done | Release notes, onboarding |
| `responsive-views` | Desktop / tablet / mobile comparisons | Web docs, responsive layouts |
| `ui-states` | Error, interaction, before/after comparisons | Blogs, social snippets |

## Output Structure

```
demo-screenshots/
├─ runs/
│  └─ <runId>/
│     ├─ feature-showcase/
│     ├─ architecture-examples/
│     ├─ workflow-stages/
│     ├─ responsive-views/
│     ├─ ui-states/
│     ├─ metadata/          # Per-screenshot JSON files for the run
│     └─ thumbnails/        # Optional thumbnails when sharp is installed
├─ latest/                  # Copy of the most recently generated run
├─ metadata/
│  ├─ index.json            # Aggregated summary for automation
│  └─ errors.json           # Validation issues captured during aggregation
└─ index.html               # Optional gallery generated by the script
```

All PNG assets are ignored by git; only the folder structure and `.gitkeep` are versioned.

## Output Quality

* 1920×1080 desktop baseline with optional presets for 4K, tablet, and mobile.
* CSS animations reduced, overlays controlled via `createScreenshotHelpers`.
* Optional PNG optimisation using `pngquant` or `optipng` when available.

## Additional Assets

Running `npm run demo:screenshots` also builds:

* Run-scoped JSON metadata (`demo-screenshots/runs/<runId>/metadata/*.json`) with viewport, component counts, scenario names, and timestamps.
* Aggregated summaries in `demo-screenshots/metadata/index.json` and validation reports in `demo-screenshots/metadata/errors.json`.
* Optional thumbnails (`demo-screenshots/runs/<runId>/thumbnails/…`) when `sharp` is installed (mirrored under `demo-screenshots/latest/`).
* `demo-screenshots/index.html` gallery for quick review.

## Environment Flags

| Flag | Default | Purpose |
| --- | --- | --- |
| `SCREENSHOT_MODE` | `'false'` | Guards expensive helpers; `isScreenshotMode()` returns `true` only when explicitly set to `'true'`. |
| `DEMO_MODE` | `'false'` | Re-enables animations and demo affordances during capture runs. |
| `SCREENSHOT_RUN_ID` | auto-generated timestamp | Overrides the run directory used by the helpers and orchestration script. |
| `PWTEST_WORKERS` | Playwright default | Forces sequential execution when set to `1` (used by CI job). |

## Helpers & Features

`e2e/utils/screenshot-helpers.ts` provides:

* Typed capture options (`captureScreenshot`, `captureSequence`).
* Organised folder structure and slugified filenames.
* Overlay toggles, highlight utilities, and viewport presets.
* Canvas stability checks (`waitForIdle` + viewport transforms) to avoid motion blur.
* Metadata builder for downstream automation.
* Mask handling that skips missing selectors with warnings rather than failing the run.
* Environment helpers (`isScreenshotMode`, `isDemoMode`) shared with the Playwright config and orchestration script.

## Customising Scenarios

1. Extend `e2e/utils/demo-scenarios.ts` with new steps.
2. Use `createScreenshotHelpers` inside the relevant spec to capture additional milestones.
3. Update `tools/scripts/generate-demo-screenshots.js` to surface the new category if needed.

## Advanced Usage

* `npm run demo:screenshots category <name>` – target a single category from CI or pre-release jobs.
* `npm run e2e:screenshots -- --reporter=list` – run capture spec interactively.
* `SCREENSHOT_MODE=1 playwright test ...` – reuse helpers inside other specs without running the orchestration script.
* `SCREENSHOT_RUN_ID=my-release npm run demo:screenshots` – force deterministic output paths for release bundles.

## Requirements

* Node.js ≥ 18
* Playwright browsers installed (`npm run demo:prepare` runs `npx playwright install` if required)
* Optional optimisation: `pngquant`, `optipng`, `sharp`

## Troubleshooting

| Issue | Fix |
| --- | --- |
| Empty output folders | Ensure `SCREENSHOT_MODE=1` or run via the provided npm scripts |
| Blurry or mid-animation captures | The helper waits for canvas stability; increase `waitFor` in capture options if needed |
| Metadata missing | Inspect `demo-screenshots/metadata/errors.json` and confirm write permissions to `demo-screenshots/` |
| Optimisation skipped | Install `pngquant` or `optipng`, or remove the optimise stage from the script |

## CI/CD Integration

The repository includes `.github/workflows/demo-screenshots.yml`, a dedicated job that runs on release publishes or manual dispatch. It enforces sequential workers (`PWTEST_WORKERS=1`) and primes the environment with `npm run demo:prepare` before capturing assets.

To embed the same behaviour in another workflow, set the flags explicitly:

```yaml
- name: Generate marketing screenshots
  env:
    CI: 'true'
    SCREENSHOT_MODE: 'true'
    DEMO_MODE: 'true'
    PWTEST_WORKERS: '1'
  run: |
    npm run demo:prepare
    npm run demo:screenshots

- name: Upload gallery
  uses: actions/upload-artifact@v4
  with:
    name: demo-screenshots
    path: demo-screenshots/
```

## Best Practices

* Run captures on stable branches after major UI updates.
* Use `SCREENSHOT_MODE` to guard expensive capture helpers inside regular specs.
* Keep palette/components tidy before capture to avoid rearranging between steps.
* Optimise PNGs before publishing to Docs or the marketing site.
* Commit scenario changes alongside updated docs so reviewers know what will be generated.
